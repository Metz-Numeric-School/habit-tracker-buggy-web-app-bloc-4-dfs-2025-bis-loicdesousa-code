# Procédure de Déploiement

Décrivez ci-dessous votre procédure de déploiement en détaillant chacune des étapes. De la préparation du VPS à la méthodologie de déploiement continu.

## Préparation du VPS & Méthode de déploiement

On installe AAPanel sur notre VM avec la commande trouvable sur leur site. On attend un petit moment pour l'installation puis on clique sur le lien 'internal' fourni, et on s'identifie avec les identifiants donnés juste en dessous.
On crée ensuite le site sur AAPanel, en cliquant sur LNMP, qui sont donc les technologies installées pour notre site.
On remplit ensuite les infos comme l'ip de la VM.

On crée le repo distant sur VPS (sur la VM), on se déplace dans var puis on crée un dossier avec mkdir, depot-git par exemple, on rentre dans ce dossier et on fait un git init --bare.
On ajoute ce nouveau repo distant à notre projet local avec une commande git remote add vps root@172.16.1.x:/var/depot-git.
On peut faire un push vers le VPS, et lancer la commande déploiement: git --work-tree=/www/wwwroot/nomdusite --git-dir=/var/depot-git checkout -f {tag} , en remplaçant donc évidemment le nom du site et le tag donc.
On ajoute ensuite le .env et on fait le composer sur aaPanel, il faut ajouter le env à la main donc on accède à document root et on l'ajoute manuellement avec le bouton de création, on pourra ensuite y accéder et ajouter le nécessaire.
On peut également ajouter une base de données avec le bouton add DB, on renseigne les informations, db username etc.

Enfin pour l'automatisation du déploiement on va faire un touch deploy.sh, puis un nano dessus. On ajoute ceci:
VARNAME=${1:?"missing arg 1 for tag name or branch name"}
git --git-dir=/var/depot_git --work-tree=/www/wwwroot/examdeploiement checkout -f $VARNAME
suite à ça on a deux choix, soit en faire un éxécutable soit faire un exe, dans ce cas je préfère faire le deuxième avec: 
chmod +x deploy.sh
./deploy.sh master # soit master/le nom de la branch soit le tag

## Mon cas

Dans mon cas précis je connaissais les démarches plutôt précisément mais arrivé à mon premier push vps j'ai eu une erreur que je n'avais jamais eu lors de mes entrainements etc:

ssh: connect to host 172.17.4.30 port 22: No route to host
fatal: Could not read from remote repository.

De moi même je pensais que le port 22 n'était pas ouvert sur ma vm, ou bien que la vm ne tournait plus, mais je peux la ping et elle peut également ping. J'ai tenté de reset le/les port(s), de redémarrer tout le processus mais rien n'a changé. En faisant des recherches je suis plusieurs fois et majoritairement tombé sur le fait que cela provienne de soucis de réseau , soit de ma machine soit de la VM, mais que ce soit en termes de technique ou de temps je n'ai pas ce qu'il faut là pendant l'examen (qui a logiquement une durée à respecter) pour régler cela.(j'ai aussi eu d'autres hypothèses qui m'ont amené à faire d'autres commandes, que le ssh avait été enlevé alors j'ai essayé de le redémarrer, j'ai même trouvé deux posts parlant du pare feu d'où je me situe (en l'occurence l'école) mais cela ne me parait pas cohérent)
J'ai cherché 
En espérant que cela puisse aider à faire comprendre mon cas, merci.